---

- name: Check if sonarqube service is running
  shell: docker service ls | awk '{print $2}' | grep sonarqube
  changed_when: sonarqube_status.rc == 1
  ignore_errors: true
  failed_when: sonarqube_status.rc == 2
  register: sonarqube_status

- name: Set fact to carry database administrator
  connection: local
  set_fact:
    postgres_password: "{{lookup('hashivault', 'service/database/postgres', 'password')}}"

- name: Set fact to carry sonarqube user
  connection: local
  set_fact:
    sonar_db_user: "{{lookup('hashivault', 'service/sonarqube', 'sonar_db_user')}}"

- name: Set fact to carry sonarqube secret
  connection: local
  set_fact:
    sonar_db_password: "{{lookup('hashivault', 'service/sonarqube', 'sonar_db_password')}}"

- name: Deploy sonarqube service
  command: |
    docker service create -d --name sonarqube \
    --network mangonet \
    --label traefik.port=9000 \
    --mount 'type=volume,"volume-opt=o=addr=grid011.sysmango.net,vers=4.1",volume-opt=device=:/srv/nfs/sonarqube/conf,volume-opt=type=nfs,target=/opt/sonarqube/conf' \
    --mount 'type=volume,"volume-opt=o=addr=grid011.sysmango.net,vers=4.1",volume-opt=device=:/srv/nfs/sonarqube/data,volume-opt=type=nfs,target=/opt/sonarqube/data' \
    --mount 'type=volume,"volume-opt=o=addr=grid011.sysmango.net,vers=4.1",volume-opt=device=:/srv/nfs/sonarqube/logs,volume-opt=type=nfs,target=/opt/sonarqube/logs' \
    --mount 'type=volume,"volume-opt=o=addr=grid011.sysmango.net,vers=4.1",volume-opt=device=:/srv/nfs/sonarqube/extensions,volume-opt=type=nfs,target=/opt/sonarqube/extensions' \
    --replicas 1 \
    -e sonar.jdbc.username={{sonarqube_db_user}} \
    -e sonar.jdbc.password={{sonarqube_db_passwd}} \
    -e sonar.jdbc.url=jdbc:postgresql://{{db_host}}/{{sonarqube_db_user}} \ \
    {{sonarqube_docker_image}}:{{sonarqube_docker_image_tag}}
  run_once: true
  when: sonarqube_status.rc == 1
